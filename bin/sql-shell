#!/usr/bin/env ruby
# Interactive SQL shell for querying the iMessage database with readline history

require_relative '../lib/messages'
require_relative '../lib/dev/print_query'
require 'readline'
require 'fileutils'

$db = Messages.init

histfile = "#{ENV['HOME']}/.config/imsg-grep/history"
FileUtils.mkdir_p File.dirname(histfile)
Readline::HISTORY.push(*File.readlines(histfile).map(&:chomp)) if File.exist?(histfile)

while buf = Readline.readline("sql> ", true)
  break if buf.strip =~ /^(exit|quit)$/i
  begin
    Print.query(buf)
    File.write(histfile, "#{buf}\n", mode: 'a')
  rescue => e
    puts "Error: #{e.message}"
  end
end
