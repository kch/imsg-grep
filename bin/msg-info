#!/usr/bin/env ruby
# Display detailed information about a specific message by ID from the iMessage database

require_relative '../lib/imsg-grep/dev/print_query'
require_relative '../lib/imsg-grep/messages'

db = Messages.init

def print_results(results2)
  puts "\n#{'=' * 80}"

  cols, *rows = results2
  width = cols.map(&:length).max
  rows.each do |row|
    row.each_with_index do |val, i|
      if cols[i] == "payload_json" && val
        val = IO.popen("jq -C", "r+") { |jq| jq << val; jq.close_write; jq.read.chomp }
      else
        val = val.nil? ? "NULL" : val.to_s
        val = val.gsub("\n", "\n   " + ' ' * width)
      end
      puts "#{cols[i].ljust(width, ' ')} : #{val}"
    end
    puts "-" * 80
  end
end

def print_message_details(db, msg_id)
  id_cond = msg_id =~ /-/ ? "orig.guid" : "orig.ROWID"
  print_results db.execute2(<<~SQL, msg_id)
    SELECT
      -- Core identifiers
      m.message_id,
      m.guid,
      m.utc_time,
      -- -- Timing
      -- m.utc_time,

      -- -- Chat context
      -- m.chat_style,
      -- m.chat_name,

      -- -- Message content

      m.sender_name,
      m.sender_searchable,
      m.recipient_searchable,
      m.recipient_name,
      m.recipient_names,
      m.recipients_searchable,
      m.member_names,
      m.members_searchable,

      m.has_attachments,
      m.is_from_me,
      orig.text as text_original,
      m.text,
      unarchive_string(orig.attributedBody) as text_fresh,

      -- Raw message fields
      orig.subject,
      orig.service,
      orig.account,
      orig.date,
      orig.date_read,
      orig.date_delivered,

      -- Thread/Reply
      orig.thread_originator_guid,
      orig.thread_originator_part,
      orig.reply_to_guid,

      -- Metadata
      orig.version,
      orig.sort_id,
      orig.share_status,
      orig.share_direction,
      orig.group_action_type,
      orig.balloon_bundle_id,
      orig.destination_caller_id,
      orig.associated_message_type,
      orig.associated_message_guid,

      -- Status flags
      orig.is_delivered,
      orig.is_finished,
      orig.is_emote,
      orig.is_delayed,
      orig.is_auto_reply,
      orig.is_prepared,
      orig.is_read,
      orig.is_system_message,
      orig.is_sent,
      orig.is_forward,
      orig.is_service_message,
      orig.is_spam,
      orig.error,

      -- Big Data
      HEX(orig.attributedBody) as attributedBody_hex,
      HEX(orig.payload_data) as payload_data_hex,
      unarchive_keyed(m.payload_data) as payload_json


    FROM  _imsg.message orig
    LEFT JOIN message_view m ON m.message_id = orig.ROWID
    WHERE #{id_cond} = ?
  SQL


  id_cond = msg_id =~ /-/ ? "(SELECT ROWID FROM message WHERE guid = ?)" : "?"
  Print.query(<<~SQL, msg_id)
    SELECT a.ROWID, a.filename, a.mime_type, a.uti,
    a.created_date,
    a.hide_attachment,
    a.total_bytes,
    a.transfer_name
    FROM _imsg.attachment a
    JOIN _imsg.message_attachment_join maj ON a.ROWID = maj.attachment_id
    JOIN _imsg.message m ON maj.message_id = m.ROWID
    WHERE m.ROWID IN (#{id_cond})
  SQL


end

if __FILE__ == $0 && ARGV[0]
  ARGV.each do |id|
    print_message_details(db, id)
  end
end
