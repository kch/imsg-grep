#!/usr/bin/env ruby
# Display detailed information about a specific message by ID from the iMessage database

require_relative '../lib/dev/print_query'
require_relative '../lib/messages'

db = Messages.init

def print_message_details(db, msg_id)
  id_cond = msg_id =~ /-/ ? "orig.guid" : "orig.ROWID"
  print_query(db, msg_id, <<~SQL)
    SELECT
      -- Core identifiers
      m.message_id,
      m.guid,
      m.utc_time,
      -- -- Timing
      -- m.utc_time,

      -- -- Chat context
      -- m.chat_style,
      -- m.chat_name,

      -- -- Message content
      m.sender_name,
      m.recipient_names,
      -- m.sender_details,
      -- m.participant_details,
      -- (SELECT COALESCE(json_extract(contact, '$.name'), m.sender_handle)
      --  FROM contact_details WHERE handle = m.sender_handle) as sender_name,

      -- (SELECT json_group_array(COALESCE(
      --    (SELECT json_extract(contact, '$.name') FROM contact_details WHERE handle = value),
      --    value
      --  ))
      --  FROM json_each(m.participant_handles)
      -- ) as participant_names,
      -- m.computed_text,
      -- m.payload,
      m.has_attachments,
      m.is_from_me,
      orig.text as text_original,
      m.text,
      unarchive_string(orig.attributedBody) as text_fresh,

      -- Raw message fields
      orig.subject,
      orig.service,
      orig.account,
      orig.date,
      orig.date_read,
      orig.date_delivered,
      HEX(orig.attributedBody) as attributedBody_hex,
      HEX(orig.payload_data) as payload_data_hex,

      -- Thread/Reply
      orig.thread_originator_guid,
      orig.thread_originator_part,
      orig.reply_to_guid,

      -- Metadata
      orig.version,
      orig.sort_id,
      orig.share_status,
      orig.share_direction,
      orig.group_action_type,
      orig.associated_message_type,
      orig.associated_message_guid,
      orig.destination_caller_id,
      orig.balloon_bundle_id,
      orig.associated_message_type,

      -- Status flags
      orig.is_delivered,
      orig.is_finished,
      orig.is_emote,
      orig.is_delayed,
      orig.is_auto_reply,
      orig.is_prepared,
      orig.is_read,
      orig.is_system_message,
      orig.is_sent,
      orig.is_forward,
      orig.is_service_message,
      orig.is_spam,
      orig.error

    FROM  _imsg.message orig
    LEFT JOIN message_view m ON m.message_id = orig.ROWID
    WHERE #{id_cond} = ?
  SQL


  id_cond = msg_id =~ /-/ ? "(SELECT ROWID FROM message WHERE guid = ?)" : "?"
  Print.query(<<~SQL, msg_id)
    SELECT a.ROWID, a.filename, a.mime_type, a.uti,
      m.ROWID as message_id
    FROM _imsg.attachment a
    JOIN _imsg.message_attachment_join maj ON a.ROWID = maj.attachment_id
    JOIN _imsg.message m ON maj.message_id = m.ROWID
    WHERE m.ROWID IN (#{id_cond})
  SQL


end

if __FILE__ == $0 && ARGV[0]
  ARGV.each do |id|
    print_message_details(db, id)
  end
end
